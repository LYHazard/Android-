# 蓝牙入门学习

## 何为蓝牙

 蓝牙是一种低功耗的无线连接技术，是一种设备间短距离的无线通讯方式，这句话表明以下几个信息，

1、低功耗技术

2、蓝牙跨设备通信

3、蓝牙属于短距离通信方式

4、蓝牙是一种无线通信方式，既然是无线通信那么势必需要通讯协议标准即蓝牙通信协

蓝牙在使用时有三种功能

* 跨设备传输流式音频
* 跨设备传输数据
* 广播信息

蓝牙技术有**两种类型**，**三种通信方式**

**两种类型**

* **传统蓝牙**

  Basic Rate/Enhanced Data Rate (BR/EDR)基本速率/增强数据速率即所谓的传统蓝牙技术（蓝牙版本2.0/2.1）：仅支持P2P一种通信方式，即1：1设备间通信，具有持续无线连接、优化音频流的特点，所以是蓝牙耳机、蓝牙扬声器等音频传输的理想方案

* **ble低功耗蓝牙**

  Low Energy(LE)低功耗即所谓的新型的低功耗蓝牙技术（蓝牙版本4.0/4.1/4.2/4.3），支持三种通信方式：第一，P2P(point-to-point)（点对点）:1:1支持短时间无限连接，优化了数据传输能量消耗，可用于无线键盘、无线鼠标等。第二，broadcast（广播信息）:1:m。可以实现本地化信息共享。广播信息顾名思义，一u设备接受该信息并进行处理。比如beacon。第三，mesh(网格): M：M

**三种通信方式即三种拓扑结构对比：**

| 连接方式   | 网络拓扑结构      | 典型应用             |
| ---------- | ----------------- | -------------------- |
| 点对点连接 | 点对点（1：1）    | 手机和音箱之间       |
| 广播连接   | 点对多点（1：m）  | 机场导航服务         |
| mesh连接   | 多点对多点（m:m） | 大规模楼宇自动化之间 |

两种辣眼技术对比：

| 蓝牙技术                        | 传统蓝牙                                                     | 低功耗蓝牙                                                   |
| ------------------------------- | ------------------------------------------------------------ | ------------------------------------------------------------ |
| 简称                            | BR/EDR                                                       | BLE                                                          |
| 全称                            | Basic rate/Enhanced Data Rate                                | Low Energy                                                   |
| 特点                            | 基本速率/增强数据速率                                        | 低功耗                                                       |
| 频带                            | 2.4GHZ（2.402GHZ-2.480GHZ）                                  | 2.4GHZ（2.402GHZ-2.480GHZ）                                  |
| 通道（channel）                 | 79个通道，每个通道之间间隔位1MHZ（2480与2402相差78MHZ）      | 共40个通道，每个通道之间间隔2MHZ，其中有3个广告通道和37个数据通道 |
| 通道应用                        | 自适应调频Adaptive frequency hopping（AFH），1600跳/秒       | 自适应调频Adaptive frequency hopping（AFH），1600跳/秒       |
| 调制（modulation.射频信号相关） | GFSK                                                         | GFSK，Π/4 DQPSK，8DPSK                                       |
| 连接建立耗时（setuptime）       | 100ms                                                        | <6ms                                                         |
| 传输速率（data rate）           | 速率范围为：1Mb/s-3Mb/s <br> EDR PHY(8DPSK):3 Mb/s<br> EDR PHY(Π/4 DQPSK): 2 Mb/s<br> BR PHY(GFSK): 1 Mb/s | 速率范围为：125kb/s-2Mb/s<br> LE 2M PHY:2 Mb/s<br> LE 1M PHY: 1 Mb/s<br> LE Coded PHY (S=2):500 Kb/s<br> LE Coded PHY(S=8):125 Kb/s |
| 最大连接数                      | 7                                                            | 无限制（需要自己实现）                                       |
| 拓扑结构                        | 点对点：优化了音频流传输，适合长时间持续的无线传输           | 点对点：优化了数据传输，适合短时间内的数据通信<br> 广播 ：优化了本地信息的共享<br> mesh:能够创建定制化的大型设备网络 |
| 最大负荷（payload）             | 点对点：1021字节                                             | 点对点：251字节<br> 广播：<br> 主要频道：31字节<br> 次要频道：255字节<br> 链接更大的消息数据包<br> mesh:29字节 |
| 安全性                          | 用户自定义应用层安全                                         | 点对点：128位的AES加密密钥<br> 广播：用户自定义应用层安全<br> mesh:128位AES加密 |
| 服务定义                        | 点对点：传统配置文件                                         | 点对点：GATT配置文件<br> 广播：beacon的形式<br> mesh:网络模型，网格属性 |
| 适用场景                        | 适用于长时间的音频流传输<br> 点对点：音箱、耳机、免提车载配件等众多无线设备 | 适用于短时间的数据传输。<br> 点对点：可穿戴智能设备、健康数据检测仪、笔记本电脑外设、以及电脑配件<br> 广播：地表信息、物品搜索和导航等服务的beacon解决方案<br> mesh:楼宇自动化、传感器网络等需要让数以万记个设备在可靠、安全的环境下传输的解决方案 |

既然有两种类型的蓝牙技术，按照排列组合自然有三种蓝牙规格，不同之处就在于锁搭载的蓝牙技术，一般手机都是蓝牙双模的。

1. 搭载蓝牙BR/EDR——传统蓝牙模块，建立相对较短距离的持续无线连接，因此非常适用于流式音频等应用
2. 搭载蓝牙LE——可建立短时间的长距离无线电连接，非常适用于无需持续连接但依赖电池具有较长寿命的的物联网 (IoT) 应用
3. 双模—-同时搭载蓝牙le和传统蓝牙两种技术。双模芯片可支持需要连接 BR/EDR 设备（例如音频耳机）以及 LE 设备（例如穿戴设备或零售信标）的单一设备（例如智能手机或平板电脑）



​	**按照版本来说**，蓝牙又分为好多版本，常见的比如2.0/2.1/4.0/4.1/4.2/4.3，不同的蓝牙规格，以及蓝牙的数据传输速率、蓝牙通信距离等都有所不同。

​	**每种蓝牙规格又不同的蓝牙规范**，蓝牙规范包含两部分：

​	1、一部分是应用层协议，比如hfp，a2dp等等各种profile上层配置文件，称之为蓝牙应用层规范

​	2、另一个部分就是蓝牙的核心规范--BluetoothCoreSpecification,蓝牙sig官网又各个版本对应的核心规范规格书

***

# 蓝牙的组成

蓝牙模块共有三大部分组成：

* HOST：主机，L2CAP以及L2CAP以上

L2CAP：即Logical Link Control and Adaptation Layer Protocol，是介于上层和底层（例如HCI）之间的一种数据交互的媒介

主要功能：

1）Protocol/channel multiplexing，协议/通道的多路复用；

2）Segmentation and reassembly，上层应用数据（即L2CAP Service Data Units，SDUs）的分割和重组；

3）Flow control per L2CAP channel，基于L2CAP Channel的流控机制；

4）Error control and retransmissions，错误控制和重传机制；

5）Support for Streaming，支持流传输（如音频、视频等，不需要重传或者只需要有限重传）；

6）Fragmentation and Recombination，PDU（Protocol Data Unit）的分片和重组

7）Quality of Service，QoS的支持。

* Controller ：控制器，HCI以下
* HCI：主机控制接口，传输主机host和controller之间的接口，记录了从host到controller的commands命令以及controller到host的响应events



每个蓝牙芯片包含唯一的一个host，以及唯一的一个主控制器Primary Controller 和0个或者多一个的从控制器Secondary Controller。也就是说host只能有一个，但是controller可以有多个

而蓝牙的controller控制器共有三种：

- BR/EDR controller：在蓝牙芯片中只能作为主控制器
- LE controller : 只能作为主控制器
- AMP controller：只能作为从控制器，且可以有一个或多个



​	其实还有一种控制器那就是BR/EDR和LE控制器结合起来的**双模控制器**。那么根据控制器的类型以及组合规则可以看到，蓝牙核心系统有以下几种组合情况。

![图片](https://mmbiz.qpic.cn/mmbiz_png/frMsQia9rIXMGicEKCRVRMstuAgJawqPL43RUPjVxyiadwttdO35ico5Z7gvG6ED0fiafcSckn0T0q8JVIIcWaqWKicQ/640?wx_fmt=png&tp=webp&wxfrom=5&wx_lazy=1&wx_co=1)

​	由图可知一共有七个大类，平常所说的蓝牙属于传统蓝牙还是ble蓝牙是什么意思呢？这说的就是蓝牙的规格，而蓝牙规格也是由主控制器PrimaryController决定的。从图中可以看出蓝牙主控制器共有三种选择，所以也就决定了蓝牙的核心规格有三种。

* 主控制器位BR/EDR Controller：即为传统蓝牙模块；
* 主控制器位LE Controller：即为BLE蓝牙模块
* 主控制器位BR/EDR和LE Controller结合成的controller：即为双模蓝牙

***

# 蓝牙入门学习--初始协议栈

​	蓝牙信息在物理信道上是分组传播的，每组包含3部分，其中有一部分称之为分组头，在分组头中有3bit标识了激活地址，所以激活地址选择有8种000,001，...111,但是000是预留地址，主节点没有激活地址，所以有7个激活地址供从节点使用，这也是为什么**最多同时能和7个设备通信**。

​	由此，正好引出了蓝牙的网络拓扑结构有两种，一种是微微网Piconet,一种是散射网Scaternet。微微网中只有一个主节点，有1到7个从节点.散射网是由多个微微网组成的，所以某个微微网中的主节点有可能是另一个微微网中的从节点。

![图片](https://mmbiz.qpic.cn/mmbiz_png/frMsQia9rIXPl2I7Za9HdCKKwl4yUfw5sbxFNicDmqyIGcQ887n4bA81LapnGcrBHrfOxCUtp1YkpejCUCCQQ2FQ/640?wx_fmt=png&tp=webp&wxfrom=5&wx_lazy=1&wx_co=1)

也就是意味着蓝牙的承载能力最大为7个设备，对比有线是极大的优势。

​	一项技术如果想要继续发展下去就必须保证所有蓝牙设备之间的兼容性，必须要求各个实现蓝牙的设备遵循一个规则，参考网络协议结构，蓝夜也构建了自己的协议体系。但是这就需要有一个团体来制定一个标准来制定所有的规则。于是一个**蓝牙兴趣小组sig**就诞生了。

​	蓝牙SIG制定了从底层到应用层的各种协议的具体要求，也制定了profile来规范如何使用应用层的协议来实现功能。其实意思就相当于类似网络协议模型中很多层，各个层都有很多协议，蓝牙sig就是模仿网络协议制定了蓝牙各种协议。

***

### 蓝牙协议共分成四类：

1，蓝牙核心协议：基带管理BB（baseBand）,链路管理LMP（LinkManagerProtocol）,链路控制和适配L2CAP（LogicalLinkControlAndAdaptionProtocol）,服务发现SDP(ServiceDiscoveryProtocol)协议。

2、蓝牙电缆替代协议：RFCOMM协议

3、蓝牙电话控制协议：电话通信协议TCS协议，AT命令集

4、蓝牙选用协议：PPP，obex，Vcard，Vcal等等。



​	同时蓝牙SIG也会提供profile，来规范如何使用这些协议，比如OPP (ObjectProfile）等等。相当于蓝牙sig给你做出来一系列的工具，并告诉你如果想要实现某些功能你要用到哪些工具、如何使用这些工具以及使用这些工具的先后顺序。有了这些，就可以搭建出某个profile的结构。

***



如下图是***文件传输应用协议的协议结构图\***

![图片](https://mmbiz.qpic.cn/mmbiz_png/frMsQia9rIXPl2I7Za9HdCKKwl4yUfw5sC07c8TA9Kg9NEMPyJ9JhCNX0iaw4vDPmqkxVnaL1HJoicvJa68DNnibjg/640?wx_fmt=png&tp=webp&wxfrom=5&wx_lazy=1&wx_co=1)

***

整个蓝牙协议体系是如下图所示：

![图片](https://mmbiz.qpic.cn/mmbiz_png/frMsQia9rIXPl2I7Za9HdCKKwl4yUfw5sXTlDhcD1a7jcSlibf3e8P0IozeDqE4Q4TM9Ttwv4BTswQNJLp05tF9Q/640?wx_fmt=png&tp=webp&wxfrom=5&wx_lazy=1&wx_co=1)

上图各模块的作用如下：

1、RF射频模块：用于过滤和传输数据，发送数据时进行载波调制，接收数据时进行电波的高频信号解调。说白了射频的目的就是能够保证通过蓝牙发送出的点播工作在2.4Ghz频段，以及保证过滤到的是2.4GHZ的信号。起到一个滤波器和信号发送器和接收器的作用。

2、BB基带层模块：实现电路交换和分组交换（具体的之后分析）

3、LMP链路管理：管理蓝牙设备间的链路的建立和解除链接，以及传输链路的切换和传输过程中的安全加密。蓝牙包括两种链路ACL(AsychronousConnectionless面向无连接的异步链路，适用于发送数据）和SCO（Synchronous Connection Oriented面向连接的同步链路，适用于发送语音）

4、L2CAP逻辑链路控制和适配协议：蓝牙在信道传输是分组传输，该协议用于对数据进行分组、提取、重新组装。

5、SDP服务发现协议：用于发现对方蓝牙设备支持什么样的应用层profile，比如通过扫描到的BluetoothDevice获取到所支持的uuid，每个应用层profile都有其对应的profile。通常我们在设置--蓝牙配对详情界面所看到的可用配置项就是sdp作用的结果。

6、TCS（TelephoneCommunicationProtocal）电话通信协议：用于实现通过蓝牙设备来呼叫拨打电话。

​	蓝牙协议体系暂时就这么多，简单理解就是有一个叫做sig的组织，规定了一些蓝牙的基本协议，然后为了实现某个功能比如文件传输，你需要从这些协议中挑出需要用哪些协议，以及这些协议如何进行协作，于是文件传输的应用profile体系就出来。



当然你在搭建这个profile时sig给了你一个大的框架那就是最底层是射频和基带来保证无线电波的过滤和产生，紧接着就是一个带有传输层协议的中间层来处理传输过程中的数据包，最后就是一些应用层的协议了。

